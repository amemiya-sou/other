from flask import Flask, render_template, request
import cv2
import numpy as np
import pytesseract
from PIL import Image, ImageFilter
import Levenshtein
import base64
import os

app = Flask(__name__)

# 事前に用意したフルーツの画像
fruit_images = {
    "かくとう": cv2.imread("img/kakutou.png"),
    "どく": cv2.imread("img/doku.png"),
    "あく": cv2.imread("img/aku.png"),
    "でんき": cv2.imread("img/denki.png"),
    "ドラゴン": cv2.imread("img/doragon.png"),
    "エスパー": cv2.imread("img/esper.png"),
    "フェアリー": cv2.imread("img/fairy.png"),
    "ゴースト": cv2.imread("img/ghost.png"),
    "はがね": cv2.imread("img/hagane.png"),
    "ひこう": cv2.imread("img/hikou.png"),
    "ほのお": cv2.imread("img/honoo.png"),
    "いわ": cv2.imread("img/iwa.png"),
    "こおり": cv2.imread("img/koori.png"),
    "くさ": cv2.imread("img/kusa.png"),
    "みず": cv2.imread("img/mizu.png"),
    "むし": cv2.imread("img/mushi.png"),
    "ノーマル": cv2.imread("img/normal.png"),
    "じめん": cv2.imread("img/zimen.png"),
    "ステラ": cv2.imread("img/sutera.png"),
}

# 読み取る言葉のリスト
target_words = [
                "ヒトカゲ",
                "リザード",
                "リザードン",
                                "アーボ",
                                "アーボック",
                                "ピカチュウ",
                                "ライチュウ",
                                "サンド",
                                "サンドパン",
                                "ピッピ",
                                "ピクシー",
                                "ロコン",
                                "キュウコン",
                                "プリン",
                                "プクリン",
                                "コンパン",
                                "モルフォン",
                                "ディグダ",
                                "ダグトリオ",
                                "ニャース",
                                "ペルシアン",
                                "コダック",
                                "ゴルダック",
                                "マンキー",
                                "オコリザル",
                                "ガーディ",
                                "ウインディ",
                                "ニョロモ",
                                "ニョロゾ",
                                "ニョロボン",
                                "マダツボミ",
                                "ウツドン",
                                "ウツボット",
                                "イシツブテ",
                                "ゴローン",
                                "ゴローニャ",
                                "ヤドン",
                                "ヤドラン",
                                "コイル",
                                "レアコイル",
                                "ベトベター",
                                "ベトベトン",
                                "シェルダー",
                                "パルシェン",
                                "ゴース",
                                "ゴースト",
                                "ゲンガー",
                                "スリープ",
                                "スリーパー",
                                "ビリリダマ",
                                "マルマイン",
                                "ドガース",
                                "マタドガス",
                                "ラッキー",
                                "ストライク",
                                "ケンタロス",
                                "コイキング",
                                "ギャラドス",
                                "メタモン",
                                "イーブイ",
                                "シャワーズ",
                                "サンダース",
                                "ブースター",
                                "カビゴン",
                                "フリーザー",
                                "サンダー",
                                "ファイヤー",
                                "ミニリュウ",
                                "ハクリュー",
                                "カイリュー",
                                "ミュウツー",
                                "ミュウ",
                                "ヒノアラシ",
                                "マグマラシ",
                                "バクフーン",
                                "オタチ",
                                "オオタチ",
                                "ホーホー",
                                "ヨルノズク",
                                "イトマル",
                                "アリアドス",
                                "ピチュー",
                                "ピィ",
                                "ププリン",
                                "メリープ",
                                "モココ",
                                "デンリュウ",
                                "マリル",
                                "マリルリ",
                                "ウソッキー",
                                "ニョロトノ",
                                "ハネッコ",
                                "ポポッコ",
                                "ワタッコ",
                                "エイパム",
                                "ヒマナッツ",
                                "キマワリ",
                                "ヤンヤンマ",
                                "ウパー",
                                "ヌオー",
                                "エーフィ",
                                "ブラッキー",
                                "ヤミカラス",
                                "ヤドキング",
                                "ムウマ",
                                "キリンリキ",
                                "クヌギダマ",
                                "フォレトス",
                                "ノコッチ",
                                "グライガー",
                                "ハリーセン",
                                "ハッサム",
                                "ヘラクロス",
                                "ニューラ",
                                "ヒメグマ",
                                "リングマ",
                                "マグマッグ",
                                "マグカルゴ",
                                "ウリムー",
                                "イノムー",
                                "デリバード",
                                "デルビル",
                                "ヘルガー",
                                "ゴマゾウ",
                                "ドンファン",
                                "オドシシ",
                                "ハピナス",
                                "ヨーギラス",
                                "サナギラス",
                                "バンギラス",
                                "ポチエナ",
                                "グラエナ",
                                "ハスボー",
                                "ハスブレロ",
                                "ルンパッパ",
                                "タネボー",
                                "コノハナ",
                                "ダーテング",
                                "キャモメ",
                                "ペリッパー",
                                "ラルトス",
                                "キルリア",
                                "サーナイト",
                                "アメタマ",
                                "アメモース",
                                "キノココ",
                                "キノガッサ",
                                "ナマケロ",
                                "ヤルキモノ",
                                "ケッキング",
                                "マクノシタ",
                                "ハリテヤマ",
                                "ルリリ",
                                "ノズパス",
                                "ヤミラミ",
                                "アサナン",
                                "チャーレム",
                                "バルビート",
                                "バルビート",
                                "ゴクリン",
                                "マルノーム",
                                "ドンメル",
                                "バクーダ",
                                "コータス",
                                "バネブー",
                                "ブーピッグ",
                                "サボネア",
                                "ノクタス",
                                "チルット",
                                "チルタリス",
                                "ザングース",
                                "ハブネーク",
                                "ドジョッチ",
                                "ナマズン",
                                "ヘイガニ",
                                "シザリガー",
                                "ヒンバス",
                                "ミロカロス",
                                "カゲボウズ",
                                "ジュペッタ",
                                "ヨマワル",
                                "サマヨール",
                                "トロピウス",
                                "チリーン",
                                "ユキワラシ",
                                "オニゴーリ",
                                "ラブカス",
                                "タツベイ",
                                "コモルー",
                                "ボーマンダ",
                                "カイオーガ",
                                "グラードン",
                                "レックウザ",
                                "ジラーチ",
                                "ナエトル",
                                "ハヤシガメ",
                                "ドダイトス",
                                "ヒコザル",
                                "モウカザル",
                                "ゴウカザル",
                                "ポッチャマ",
                                "ポッタイシ",
                                "エンペルト",
                                "ムックル",
                                "ムクバード",
                                "ムクホーク",
                                "コロボーシ",
                                "コロトック",
                                "コリンク",
                                "ルクシオ",
                                "レントラー",
                                "ミツハニー",
                                "ビークイン",
                                "パチリス",
                                "ブイゼル",
                                "フローゼル",
                                "カラナクシ",
                                "トリトドン",
                                "エテボース",
                                "フワンテ",
                                "フワライド",
                                "ムウマージ",
                                "ドンカラス",
                                "リーシャン",
                                "スカンプー",
                                "スカタンク",
                                "ドーミラー",
                                "ドータクン",
                                "ウソハチ",
                                "ピンプク",
                                "ミカルゲ",
                                "フカマル",
                                "ガバイト",
                                "ガブリアス",
                                "ゴンベ",
                                "リオル",
                                "ルカリオ",
                                "ヒポポタス",
                                "カバルドン",
                                "グレッグル",
                                "ドクロッグ",
                                "ケイコウオ",
                                "ネオラント",
                                "ユキカブリ",
                                "ユキノオー",
                                "マニューラ",
                                "ジバコイル",
                                "メガヤンマ",
                                "リーフィア",
                                "グレイシア",
                                "グライオン",
                                "マンムー",
                                "エルレイド",
                                "ダイノーズ",
                                "ヨノワール",
                                "ユキメノコ",
                                "ロトム",
                                "ユクシー",
                                "エムリット",
                                "アグノム",
                                "ディアルガ",
                                "パルキア",
                                "ヒードラン",
                                "クレセリア",
                                "フィオネ",
                                "マナフィ",
                                "ダークライ",
                                "シェイミ",
                                "アルセウス",
                                "ミジュマル",
                                "フタチマル",
                                "ダイケンキ",
                                "ドッコラー",
                                "ドテッコツ",
                                "ローブシン",
                                "クルミル",
                                "クルマユ",
                                "ハハコモリ",
                                "チュリネ",
                                "ドレディア",
                                "バスラオ",
                                "メグロコ",
                                "ワルビル",
                                "ワルビアル",
                                "ゾロア",
                                "ゾロアーク",
                                "ゴチム",
                                "ゴチミル",
                                "ゴチルゼル",
                                "コアルヒー",
                                "スワンナ",
                                "シキジカ",
                                "メブキジカ",
                                "タマゲタケ",
                                "モロバレル",
                                "ママンボウ",
                                "シビシラス",
                                "シビビール",
                                "シビルドン",
                                "ヒトモシ",
                                "ランプラー",
                                "シャンデラ",
                                "キバゴ",
                                "オノンド",
                                "オノノクス",
                                "クマシュン",
                                "ツンベアー",
                                "フリージオ",
                                "コジョフー",
                                "コジョンド",
                                "コマタナ",
                                "キリキザン",
                                "ワシボン",
                                "ウォーグル",
                                "バルチャイ",
                                "バルジーナ",
                                "モノズ",
                                "ジヘッド",
                                "サザンドラ",
                                "メラルバ",
                                "ウルガモス",
                                "トルネロス",
                                "ボルトロス",
                                "ランドロス",
                                "メロエッタ",
                                "ハリマロン",
                                "ハリボーグ",
                                "ブリガロン",
                                "フォッコ",
                                "テールナー",
                                "マフォクシー",
                                "ケロマツ",
                                "ゲコガシラ",
                                "ゲッコウガ",
                                "ヤヤコマ",
                                "ヒノヤコマ",
                                "ファイアロー",
                                "コフキムシ",
                                "コフーライ",
                                "ビビヨン",
                                "シシコ",
                                "カエンジシ",
                                "フラベベ",
                                "フラエッテ",
                                "フラージェス",
                                "メェークル",
                                "ゴーゴート",
                                "クズモー",
                                "ドラミドロ",
                                "ウデッポウ",
                                "ブロスター",
                                "ニンフィア",
                                "ルチャブル",
                                "デデンネ",
                                "メレシー",
                                "ヌメラ",
                                "ヌメイル",
                                "ヌメルゴン",
                                "クレッフィ",
                                "ボクレー",
                                "オーロット",
                                "カチコール",
                                "クレベース",
                                "オンバット",
                                "オンバーン",
                                "ディアンシー",
                                "フーパ",
                                "ボルケニオン",
                                "モクロー",
                                "フクスロー",
                                "ジュナイパー",
                                "ヤングース",
                                "デカグース",
                                "アゴジムシ",
                                "デンヂムシ",
                                "クワガノン",
                                "マケンカニ",
                                "ケケンカニ",
                                "オドリドリ",
                                "アブリー",
                                "アブリボン",
                                "イワンコ",
                                "ルガルガン",
                                "ヒドイデ",
                                "ドヒドイデ",
                                "ドロバンコ",
                                "バンバドロ",
                                "カリキリ",
                                "ラランテス",
                                "ヤトウモリ",
                                "エンニュート",
                                "アマカジ",
                                "アママイコ",
                                "アマージョ",
                                "ヤレユータン",
                                "ナゲツケサル",
                                "スナバァ",
                                "シロデスナ",
                                "ネッコアラ",
                                "ミミッキュ",
                                "ハギギシリ",
                                "ジャラコ",
                                "ジャランゴ",
                                "ジャラランガ",
                                "マギアナ",
                                "サルノリ",
                                "バチンキー",
                                "ゴリランダー",
                                "ヒバニー",
                                "ラビフット",
                                "エースバーン",
                                "メッソン",
                                "ジメレオン",
                                "インテレオン",
                                "ホシガリス",
                                "ヨクバリス",
                                "ココガラ",
                                "アオガラス",
                                "アーマーガア",
                                "カムカメ",
                                "カジリガメ",
                                "タンドン",
                                "トロッゴン",
                                "セキタンザン",
                                "カジッチュ",
                                "アップリュー",
                                "タルップル",
                                "スナヘビ",
                                "サダイジャ",
                                "ウッウ",
                                "サシカマス",
                                "カマスジョー",
                                "エレズン",
                                "ストリンダー",
                                "ヤバチャ",
                                "ポットデス",
                                "ミブリム",
                                "テブリム",
                                "ブリムオン",
                                "ベロバー",
                                "ギモー",
                                "オーロンゲ",
                                "ニャイキング",
                                "タイレーツ",
                                "バチンウニ",
                                "ユキハミ",
                                "モスノウ",
                                "イシヘンジン",
                                "コオリッポ",
                                "イエッサン",
                                "モルペコ",
                                "ゾウドウ",
                                "ダイオウドウ",
                                "ドラメシヤ",
                                "ドロンチ",
                                "ドラパルト",
                                "ザシアン",
                                "ザマゼンタ",
                                "ムゲンダイナ",
                                "ダクマ",
                                "ウーラオス",
                                "ザルード",
                                "レジエレキ",
                                "レジドラゴ",
                                "ブリザポス",
                                "レイスポス",
                                "バドレックス",
                                "アヤシシ",
                                "バサギリ",
                                "ガチグマ",
                                "イダイトウ",
                                "オオニューラ",
                                "ハリーマン",
                                "ラブトロス",
                                "ニャオハ",
                                "ニャローテ",
                                "マスカーニャ",
                                "ホゲータ",
                                "アチゲータ",
                                "ラウドボーン",
                                "クワッス",
                                "ウェルカモ",
                                "ウェーニバル",
                                "グルトン",
                                "パフュートン",
                                "タマンチュラ",
                                "ワナイダー",
                                "マメバッタ",
                                "エクスレッグ",
                                "パモ",
                                "パモット",
                                "パーモット",
                                "ワッカネズミ",
                                "イッカネズミ",
                                "パピモッチ",
                                "バウッツェル",
                                "ミニーブ",
                                "オリーニョ",
                                "オリーヴァ",
                                "イキリンコ",
                                "コジオ",
                                "ジオヅム",
                                "キョジオーン",
                                "カルボウ",
                                "グレンアルマ",
                                "ソウブレイズ",
                                "ズピカ",
                                "ハラバリー",
                                "カイデン",
                                "タイカイデン",
                                "オラチフ",
                                "マフィティフ",
                                "シルシュルー",
                                "タギングル",
                                "アノクサ",
                                "アノホラグサ",
                                "ノノクラゲ",
                                "リククラゲ",
                                "ガケガニ",
                                "カプサイジ",
                                "スコヴィラン",
                                "シガロコ",
                                "ベラカス",
                                "ヒラヒナ",
                                "クエスパトラ",
                                "カヌチャン",
                                "ナカヌチャン",
                                "デカヌチャン",
                                "ウミディグダ",
                                "ウミトリオ",
                                "オトシドリ",
                                "ナミイルカ",
                                "イルカマン",
                                "ブロロン",
                                "ブロロローム",
                                "モトトカゲ",
                                "ミミズズ",
                                "キラーメ",
                                "キラフロル",
                                "ボチ",
                                "ハカドッグ",
                                "カラミンゴ",
                                "アルクジラ",
                                "ハルクジラ",
                                "ミガルーサ",
                                "ヘイラッシャ",
                                "コノヨザル",
                                "ドオー",
                                "リキキリン",
                                "ノココッチ",
                                "ドドゲザン",
                                "イダイナキバ",
                                "サケブシッポ",
                                "アラブルタケ",
                                "ハバタクカミ",
                                "チヲハウハネ",
                                "スナノケガワ",
                                "テツノワダチ",
                                "テツノツツミ",
                                "テツノカイナ",
                                "テツノコウベ",
                                "テツノドクガ",
                                "テツノイバラ",
                                "セビエ",
                                "セゴール",
                                "セグレイブ",
                                "コレクレー",
                                "サーフゴー",
                                "チオンジェン",
                                "パオジアン",
                                "ディンルー",
                                "イーユイ",
                                "トドロクツキ",
                                "テツノブジン",
                                "コライドン",
                                "ミライドン",
                                "ウネルミナモ",
                                "テツノイサハ",
                                "カミッチュ",
                                "チャデス",
                                "ヤバソチャ",
                                "イイネイヌ",
                                "マシマシラ",
                                "キチキギス",
                                "オーガポン",
                "あおぞらプレート",
                "あかいいと",
                "あついいわ",
                "あつぞこブーツ",
                "あまーいりんご",
                "いかさまダイス",
                "いかずちプレート",
                "いじっぱりミント",
                "いのちのたま",
                "イワイノヨロイ",
                "インドメタシン",
                "うすもものミツ",
                "うっかりやミント",
                "エレキシード",
                "おうじゃのしるし",
                "おおきなねっこ",
                "おくびょうミント",
                "おだやかミント",
                "おっとりミント",
                "おとなしいミント",
                "おまもりこばん",
                "おんみつマント",
                "かいがらのすず",
                "かえんだま",
                "かけたポット",
                "かしらのしるし",
                "かたいいし",
                "かみなりのいし",
                "からぶりほけん",
                "かるいし",
                "かわらずのいし",
                "がんせきプレート",
                "きあいのタスキ",
                "きあいのハチマキ",
                "きせきのタネ",
                "キトサン",
                "きゅうこん",
                "きれいなぬけがら",
                "ぎんのおうかん",
                "きんのおうかん",
                "ぎんのこな",
                "きんりょくのハネ",
                "くちたけん",
                "くちたたて",
                "くっつきバリ",
                "グラスシード",
                "グランドコート",
                "クリアチャーム",
                "くれないのミツ",
                "くろいてっきゅう",
                "くろいヘドロ",
                "くろいメガネ",
                "くろおび",
                "けいけんアメL",
                "けいけんアメM",
                "けいけんアメS",
                "けいけんアメXL",
                "けいけんアメXS",
                "けむりだま",
                "こうかくレンズ",
                "こうこうのしっぽ",
                "こうてつプレート",
                "こおりのいし",
                "こだわりスカーフ",
                "こだわりハチマキ",
                "こだわりメガネ",
                "ゴツゴツメット",
                "こぶしのプレート",
                "こわもてプレート",
                "こんごうだま",
                "サイコシード",
                "さみしがりミント",
                "さらさらいわ",
                "しあわせタマゴ",
                "じしゃく",
                "しずくプレート",
                "しめつけバンド",
                "しめったいわ",
                "じゃくてんほけん",
                "じゅうでんち",
                "しゅんぱつのハネ",
                "しらたま",
                "シルクのスカーフ",
                "しろいハーブ",
                "しんかのきせき",
                "しんちょうミント",
                "しんぴのしずく",
                "すっぱいりんご",
                "スピードパウダー",
                "ずぶといミント",
                "するどいくちばし",
                "するどいツメ",
                "せいしんのハネ",
                "せいれいプレート",
                "せっかちミント",
                "せんせいのツメ",
                "だいこんごうだま",
                "だいしらたま",
                "だいちのプレート",
                "だいはっきんだま",
                "たいようのいし",
                "たいりょくのハネ",
                "タウリン",
                "だっしゅつパック",
                "だっしゅつボタン",
                "たつじんのおび",
                "たべのこし",
                "たまむしプレート",
                "ちからのハチマキ",
                "ちりょくのハネ",
                "つきのいし",
                "つめたいいわ",
                "つららのプレート",
                "ていこうのハネ",
                "テラピースあく",
                "テラピースいわ",
                "テラピースかくとう",
                "テラピースくさ",
                "テラピースゴースト",
                "テラピースこおり",
                "テラピースじめん",
                "テラピースでんき",
                "テラピースどく",
                "テラピースドラゴン",
                "テラピースノーマル",
                "テラピースはがね",
                "テラピースひこう",
                "テラピースフェアリー",
                "テラピースほのお",
                "テラピースみず",
                "テラピースむし",
                "でんきだま",
                "とくせいガード",
                "とくせいカプセル",
                "とくせいパッチ",
                "どくどくだま",
                "どくバリ",
                "とけないこおり",
                "とつげきチョッキ",
                "なまいきミント",
                "なんでもなおし",
                "ねばりのかぎづめ",
                "ねらいのまと",
                "のうてんきミント",
                "ノーマルジュエル",
                "のどスプレー",
                "のろいのおふだ",
                "ノロイノヨロイ",
                "のんきミント",
                "はっきんだま",
                "パワーアンクル",
                "パワーウエイト",
                "パワーバンド",
                "パワーベルト",
                "パワーリスト",
                "パワーレンズ",
                "パワフルハーブ",
                "パンチグローブ",
                "ばんのうがさ",
                "ひかえめミント",
                "ひかりごけ",
                "ひかりのいし",
                "ひかりのこな",
                "ひかりのねんど",
                "ひのたまプレート",
                "ビビリだま",
                "ピントレンズ",
                "ブーストエナジー",
                "ふうせん",
                "フォーカスレンズ",
                "ふしぎなアメ",
                "ふしぎのプレート",
                "ブロムヘキシン",
                "ポイントアップ",
                "ポイントマックス",
                "ぼうごパット",
                "ぼうじんゴーグル",
                "ほのおのいし",
                "まがったスプーン",
                "まじめミント",
                "マックスアップ",
                "まんまるいし",
                "ミストシード",
                "みずのいし",
                "みどりのプレート",
                "むじゃきミント",
                "むらさきのミツ",
                "めざめいし",
                "メタルコート",
                "メタルパウダー",
                "メトロノーム",
                "メンタルハーブ",
                "もうどくプレート",
                "もくたん",
                "ものしりメガネ",
                "もののけプレート",
                "ものまねハーブ",
                "やすらぎのすず",
                "やまぶきのミツ",
                "やみのいし",
                "やわらかいすな",
                "やんちゃミント",
                "ゆうかんミント",
                "ゆきだま",
                "ようきミント",
                "リーフのいし",
                "リゾチウム",
                "りゅうのキバ",
                "りゅうのプレート",
                "ルームサービス",
                "れいせいミント",
                "レッドカード",
                "われたポット",
                "わんぱくミント",
                "ようせいのハネ",
                "みついりりんご",
                "ボンサクのちゃわん",
                "ケッサクのちゃわん",
                "いしずえのめん",
                "いどのめん",
                "かまどのめん",
                "たいりょくのもち",
                "きんりょくのもち",
                "ていこうのもち",
                "ちりょくのもち",
                "せいしんのもち",
                "しゅんぱつのもち",
                "まっさらもち",
                "きれいなウロコ",
                "するどいキバ",
                "れいかいのぬの",
                "あまいミツ",
                "ウルトラボール",
                "クイックボール",
                "ゴージャスボール",
                "コンペボール",
                "サファリボール",
                "スーパーボール",
                "スピードボール",
                "ダークボール",
                "ダイブボール",
                "タイマーボール",
                "ドリームボール",
                "ネストボール",
                "ネットボール",
                "ハイパーボール",
                "ヒールボール",
                "プレミアボール",
                "フレンドボール",
                "ヘビーボール",
                "マスターボール",
                "ムーンボール",
                "モンスターボール",
                "ラブラブボール",
                "リピートボール",
                "ルアーボール",
                "レベルボール",
                "エフェクトガード",
                "クリティカット",
                "スピーダー",
                "スペシャルアップ",
                "スペシャルガード",
                "ディフェンダー",
                "ピッピにんぎょう",
                "プラスパワー",
                "ポケじゃらし",
                "ヨクアタール",
                "アッキのみ",
                "イアのみ",
                "イトケのみ",
                "イバンのみ",
                "ウイのみ",
                "ウタンのみ",
                "ウブのみ",
                "オッカのみ",
                "オボンのみ",
                "オレンのみ",
                "カイスのみ",
                "カゴのみ",
                "カシブのみ",
                "カムラのみ",
                "キーのみ",
                "クラボのみ",
                "ゴスのみ",
                "ザロクのみ",
                "サンのみ",
                "シーヤのみ",
                "ジャポのみ",
                "シュカのみ",
                "ズアのみ",
                "スターのみ",
                "ズリのみ",
                "セシナのみ",
                "ソクノのみ",
                "タポルのみ",
                "タラプのみ",
                "タンガのみ",
                "チーゴのみ",
                "チイラのみ",
                "ドリのみ",
                "ナゾのみ",
                "ナナシのみ",
                "ナナのみ",
                "ナモのみ",
                "ネコブのみ",
                "ノメルのみ",
                "ノワキのみ",
                "パイルのみ",
                "バコウのみ",
                "ハバンのみ",
                "バンジのみ",
                "ビアーのみ",
                "ヒメリのみ",
                "フィラのみ",
                "ブリーのみ",
                "ベリブのみ",
                "ホズのみ",
                "マゴのみ",
                "マトマのみ",
                "ミクルのみ",
                "モコシのみ",
                "モモンのみ",
                "ヤタピのみ",
                "ヤチェのみ",
                "ヨプのみ",
                "ヨロギのみ",
                "ラブタのみ",
                "ラムのみ",
                "リュガのみ",
                "リリバのみ",
                "リンドのみ",
                "レンブのみ",
                "ロゼルのみ",
                "ロメのみ",
                "ねむけざまし",
                "いいキズぐすり",
                "おいしいみず",
                "かいふくのくすり",
                "キズぐすり",
                "げんきのかけら",
                "げんきのかたまり",
                "こおりなおし",
                "サイコソーダ",
                "すごいキズぐすり",
                "ちからのこな",
                "ちからのねっこ",
                "どくけし",
                "ばんのうごな",
                "ピーピーエイダー",
                "ピーピーエイド",
                "ピーピーマックス",
                "ピーピーリカバー",
                "ふっかつそう",
                "まひなおし",
                "まんたんのくすり",
                "ミックスオレ",
                "モーモーミルク",
                "やけどなおし",
                "おおきなキノコ",
                "おおきなしんじゅ",
                "おおきなタケノコ",
                "おだんごしんじゅ",
                "かおるキノコ",
                "きちょうなホネ",
                "きれいなハネ",
                "きんのたま",
                "しんじゅ",
                "すいせいのかけら",
                "ちいさなキノコ",
                "ちいさなタケノコ",
                "でかいきんのたま",
                "ほしのかけら",
                "ほしのすな",
                ]

# TesseractのOCRエンジンに日本語言語を指定
def perform_ocr(img):
    text = pytesseract.image_to_string(img, lang='jpn')
    return text

# Levenshtein距離の計算
def levenshtein_distance(str1, str2):
    distance = Levenshtein.distance(str1, str2)
    return distance

# 画像の前処理（パーセントで範囲指定および二値化、ノイズ除去）
def preprocess_image(img, percent_boxes):
    processed_images = []

    # 画像のサイズを取得
    width, height = img.size

    # 画像を拡大
    img = img.resize((width * 2, height * 2), Image.BICUBIC)

    for i, percent_box in enumerate(percent_boxes):
        # パーセントで指定された範囲を計算
        left = int(width * percent_box[0] / 100 * 2)
        top = int(height * percent_box[1] / 100 * 2)
        right = int(width * percent_box[2] / 100 * 2)
        bottom = int(height * percent_box[3] / 100 * 2)

        # 範囲指定の部分をクロップ
        cropped_img = img.crop((left, top, right, bottom))

        # 二値化
        cropped_img = cropped_img.convert("L")
        threshold = 120
        cropped_img = cropped_img.point(lambda p: p < threshold and 255)

        # 処理された画像をリストに追加
        processed_images.append(cropped_img)

    return processed_images

# 類似性スコアの計算
def similarity_score(str1, str2):
    levenshtein_distance = Levenshtein.distance(str1, str2)
    
    common_prefix = os.path.commonprefix([str1, str2])
    common_suffix = os.path.commonprefix([str1[::-1], str2[::-1]])[::-1]
    partial_match_length = len(common_prefix) + len(common_suffix)
    partial_match_score = partial_match_length / max(len(str1), len(str2))

    similarity_score = 0.7 * (1 - levenshtein_distance / max(len(str1), len(str2))) + 0.3 * partial_match_score

    return similarity_score

# 画像比較
def compare_images(img1, img2, roi_percent):
    # アップロードされた画像の指定されたパーセント範囲を切り取り
    height, width, _ = img2.shape
    roi_start = (int(width * roi_percent[0] / 100), int(height * roi_percent[1] / 100))
    roi_end = (int(width * roi_percent[2] / 100), int(height * roi_percent[3] / 100))
    uploaded_roi = img2[roi_start[1]:roi_end[1], roi_start[0]:roi_end[0]]

    # 画像サイズをアップロードされた画像に合わせてリサイズ
    img1_resized = cv2.resize(img1, (uploaded_roi.shape[1], uploaded_roi.shape[0]))

    # 差分を計算
    difference = cv2.absdiff(img1_resized, uploaded_roi)
    _, threshold_diff = cv2.threshold(difference, 30, 255, cv2.THRESH_BINARY)

    # 類似度を計算
    similarity = np.sum(threshold_diff == 0) / np.prod(threshold_diff.shape)
    return similarity

# Flaskアプリケーションのルーティング
@app.route('/')
def index():
    return render_template('index.html')

@app.route('/', methods=['POST'])
def upload_file():
    if 'file' not in request.files:
        return render_template('index.html', error='ファイルが見つかりません')

    file = request.files['file']
    if file.filename == '':
        return render_template('index.html', error='選択されたファイルがありません')

    if file:
        # 画像をBASE64形式に変換
        img_base64 = base64.b64encode(file.read()).decode('utf-8')

        # 他の画像処理コードは変更なし
        img = Image.open(file)

        # パーセントで指定された範囲（12か所）
        percent_boxes = [
            (4, 16, 19, 21),
            (7, 31, 20, 36),
            (51.5, 16, 66.6, 21),
            (54.5, 31, 69.5, 36),
            (4, 41, 19, 46),
            (7, 56, 20, 61),
            (51.5, 41, 66.5, 46),
            (54.5, 56, 67.5, 61),
            (4, 66, 19, 71),
            (7, 81, 20, 86),
            (51.5, 66, 66.6, 71),
            (54.5, 81, 69.5, 86)
        ]

        processed_images = preprocess_image(img, percent_boxes)
        texts = [perform_ocr(processed_img) for processed_img in processed_images]

        # 最も近い言葉を検索して表示
        closest_words = []
        for text in texts:
            max_similarity = 0
            closest_word = ""
            for target_word in target_words:
                similarity = similarity_score(text, target_word)
                if similarity > max_similarity:
                    max_similarity = similarity
                    closest_word = target_word
            closest_words.append(closest_word)

        # ファイルポインタを先頭に戻す
        file.seek(0)

        # ここでcv2形式に変換してフルーツの画像処理に使う
        img_cv2 = cv2.imdecode(np.frombuffer(file.read(), np.uint8), 1)

        messages = [""] * 6

        for roi_percent_idx in range(6):
            roi_percent = [
                (25.45, 16.7, 27.05, 19.2),
                (72.95, 16.7, 74.55, 19.2),
                (25.45, 41.7, 27.05, 44.2),
                (72.95, 41.7, 74.55, 44.2),
                (25.45, 66.7, 27.05, 69.2),
                (72.95, 66.7, 74.55, 69.2),
            ][roi_percent_idx]

            best_similarity = 0
            best_fruit_name = ""

            for fruit_name, reference_image in fruit_images.items():
                similarity = compare_images(reference_image, img_cv2, roi_percent)

                # 最も類似度が高いフルーツを更新
                if similarity > best_similarity:
                    best_similarity = similarity
                    best_fruit_name = fruit_name

            # 各 message 変数に最も類似度が高かったフルーツ名を格納
            messages[roi_percent_idx] = best_fruit_name

        # どれかの類似度が一定以上ならば結果のテンプレートにリダイレクト
        if any(messages):
            return render_template(
            "result.html",
            img_base64=img_base64,
            texts=texts,
            closest_words=closest_words,
            message1=messages[0],
            message2=messages[1],
            message3=messages[2],
            message4=messages[3],
            message5=messages[4],
            message6=messages[5]
        )
        
if __name__ == '__main__':
    app.run(debug=False, host='0.0.0.0')
